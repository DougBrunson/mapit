<html>
	<head>
		<title>MapIt</title>
	    <meta name="viewport" content="initial-scale=1.0">
    	<meta charset="utf-8">

		<!-- mdl -->
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.red-blue.min.css">
		<script defer src="https://code.getmdl.io/1.2.1/material.min.js"></script>
		<link rel="stylesheet" href="./css/styles.css">
	
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
        <script src="js/oauth.js"></script>
        <script src="js/sha1.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.1/knockout-min.js"></script>


	<style>
		.place_listing {
		    text-decoration: none;
		}

		.place_listing:hover, .place_listing:focus {
		    background: #e1e1e1;
		}
		.error {
			color: rgb(244,67,54);
		}

		.header {
			color: #424242;
		}

		.sidebar {
			position: relative;
		}
		
		/* super hackish css... */
		.footer {
			bottom: 0;
		}

		@media screen and (min-width: 480px) {
		    .footer {
		        position: absolute;
		    }
		}

		.footer > ul> li> img {
			padding: 2%;
		}

		.footer > ul > li {
			text-decoration: none;
			display: inline;
		}

		#google {
			width: 50%;
			margin-left: -10%;
		}

		#yelp {
			max-height: 40px;
			margin-top: -5%;
			width: 50%;
			float: right;
		}
	</style>
	</head>
	<body>
		<div class="mdl-grid mdl-grid--no-spacing">
		  <div class="mdl-cell mdl-cell--2-col-desktop mdl-cell--3-col-tablet mdl-cell--4-col-phone sidebar">
			<div class="wrap">
			  	<h2 class="header">MapIt</h2>
			  	<form action="">
				  <div class="mdl-textfield mdl-js-textfield">
				    <input data-bind="value: query" class="mdl-textfield__input" type="text" id="sample1">
				    <label class="mdl-textfield__label" for="sample1">Eg: Cafes in Cambridge</label>
				  </div>
				</form>
			    <button data-bind="click: fetchResults" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
			      Search
			    </button>
			    <button data-bind="click: luckyResults" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
			      Feeling Lucky
			    </button>
			</div>
			
			<!-- list of places -->
			<ul data-bind="foreach: locations, visible: locations().length > 0" class="demo-list-icon mdl-list">

	  			<li class="mdl-list__item place_listing">
	            <span class="mdl-list__item-primary-content"><i class="material-icons mdl-list__item-icon">place</i>
	            <span data-bind="html: displayInfo, click: toggleInfo"></span></span></li>
	        </ul>

	        <div class="footer">
        		<ul>
		        	<li><img id="google" src="img/powered_by_google.png" alt="Powered by Google"></li>
		        	<li><img id="yelp" src="img/yelp.png" alt="Yelp"></li>
        		</ul>
	        </div>
			
			<div aria-live="assertive" aria-atomic="true" aria-relevant="text" class="mdl-snackbar mdl-js-snackbar">
			    <div class="mdl-snackbar__text"></div>
			    <button type="button" class="mdl-snackbar__action"></button>
			</div>
		  </div> <!-- end sidebar -->
		  
		  <div class="mdl-cell mdl-cell--10-col-desktop mdl-cell--5-col-tablet mdl-cell--4-col-phone">
	  		   <div id="map"><h4 class="error">Map failed to load. Please try again.</h4></div>
		  </div>

		</div>

		<script>
			// welcome to beantown
			var center = {lat: 42.36, lng: -71.08};
			var map;
			var markers = [];

			function initMap() {
				map = new google.maps.Map(document.getElementById('map'), {
				  center: center,
				  zoom: 14
				});
			}

			function addMarker(place) {
				var contentString = '<div id="content">'+
  				      '<div id="siteNotice"></div>'+
				      '<h1 id="firstHeading" class="firstHeading">' + place.name +
				      '</h1><div id="bodyContent">'+
				      place.review_count + ' Reviews | ' + '<img src="' + place.rating_img_url +
				      '" alt="rating"><hr><p>' + place.snippet_text + '</p>' +
				      '<p><b>Phone: </b>' + place.display_phone +
				      '<p><b>Address: </b>' + place.location.display_address.join(" ") + '</p>'+
				      '<a href="' + place.url +'">Website</a>' +
				      '</p></div></div>';

				var infowindow = new google.maps.InfoWindow({
					content: contentString
				});
				
				var marker = new google.maps.Marker({
					position: {lat:place.location.coordinate.latitude, lng:place.location.coordinate.longitude},
					map: map
				});
				
				marker.addListener('click', function() {
				    infowindow.open(map, marker);
			    });

			    map.addListener('click', function() {
			    	infowindow.close(map, marker);
			    });
				
				markers.push(marker)
			}

			function setMapOnAll(map) {
		        for (var i = 0; i < markers.length; i++) {
		          markers[i].setMap(map);
	      		}
		  	}

      		// Removes the markers from the map, but keeps them in the array.
	      	function clearMarkers() {
	      		setMapOnAll(null);
	      	}

	        // Shows any markers currently in the array.
		    function showMarkers() {
		    	setMapOnAll(map);
		    }

		    // Deletes all markers in the array by removing references to them.
		    function deleteMarkers() {
		    	clearMarkers();
		    	markers = [];
		    }


            function cb(data) {
            	console.log('hello...');
            }
            
            function markerFilter(coord, m) {
            	for(var i = 0; i < m.length; i++) {
            		if (m[i].position.lat().toFixed(13) === coord.latitude.toFixed(13) && m[i].position.lng().toFixed(13) === coord.longitude.toFixed(13)) {
            			return m[i];
            		} 
            	}
            }

            function animate(marker) {
            	marker.setAnimation(google.maps.Animation.BOUNCE);
            	setTimeout(function(){marker.setAnimation(null);}, 775);
            }

        	//  main app
        	function Location(data) {
        		var self = this;
        		self.isVisible = ko.observable(false);

        		self.name = ko.observable(data.name);
        		self.address = ko.observable(data.location.address);
        		self.city = ko.observable(data.location.city);
        		self.center = ko.observable(data.location.coordinate);
        		self.rating_img = ko.observable(data.rating_img_url_large);
        		self.num_ratings = ko.observable(data.review_count);
        		self.phone = ko.observable(data.display_phone);
        		self.url = ko.observable(data.url);
        		self.image = ko.observable(data.image_url);

        		self.toggleInfo = function() {
        			self.isVisible(!self.isVisible());
        		}

        		self.displayInfo = ko.computed(function() {
        			if (self.isVisible()) {
        				// animate marker and display info
        				animate(markerFilter(self.center(), markers));
        				return self.name() + '<hr><ul><li>' + self.phone() + '</li><li>' + self.address() + '</li></ul>';
        			} else {
        				return self.name();
        			}
        		});
        	}

        	function ViewModel() {
        		var self = this;
        		self.query = ko.observable("");
        		self.locations = ko.observableArray([]);
        		self.markers = ko.observableArray([]);

				// modified hack around yelp api v2 cors block courtesy of:
				// https://gist.github.com/mnemonicflow/1b90ef0d294c692d24458b8378054c81
        		// todo: upgrade to api v3
        		self.yelpSearch = function(query) {
	                var auth = {
	                    // Update with your auth tokens.
	                    consumerKey : "zMiWRLyNndWvmOsyA1Y3gQ",
	                    consumerSecret : "gWYPzYjf38LLI7-DUzTYiLcaCNg",
	                    accessToken : "eIVlS5yuN8zlYOrEAfkMHBTDi9SbI9eo",
	                    // This example is a proof of concept, for how to use the Yelp v2 API with javascript.
	                    // You wouldn't actually want to expose your access token secret like this in a real application.... but this is a udacity project so lulz it is
	                    accessTokenSecret : "ekIo1SCq4Izfa-kPukRTSZdCw5E",
	                    serviceProvider : {
	                        signatureMethod : "HMAC-SHA1"
	                    }
	                };
	        		

	                var accessor = {
	                    consumerSecret : auth.consumerSecret,
	                    tokenSecret : auth.accessTokenSecret
	                };

	        		var q = query.split(" in ");
	        		var terms = q[0];
	        		var near = q[1];

	                var parameters = [];
	                parameters.push(['term', terms]);
	                parameters.push(['location', near]);
	                parameters.push(['limit', 8]);
	                parameters.push(['callback', 'cb']);
	                parameters.push(['oauth_consumer_key', auth.consumerKey]);
	                parameters.push(['oauth_consumer_secret', auth.consumerSecret]);
	                parameters.push(['oauth_token', auth.accessToken]);
	                parameters.push(['oauth_signature_method', 'HMAC-SHA1']);
	        
	                var message = {
	                    'action' : 'https://api.yelp.com/v2/search',
	                    'method' : 'GET',
	                    'parameters' : parameters
	                };
	        
	                OAuth.setTimestampAndNonce(message);
	                OAuth.SignatureMethod.sign(message, accessor);
	        
	                var parameterMap = OAuth.getParameterMap(message.parameters);
	                    
	                $.ajax({
	                    'url' : message.action,
	                    'data' : parameterMap,
	                    'dataType' : 'jsonp',
	                    'jsonpCallback' : 'cb',
	                    'cache': true
	                })
	                .done(function(data, textStatus, jqXHR) {
	                	// pan map
	                	search_location = {lat:jqXHR.responseJSON.region.center.latitude, lng: jqXHR.responseJSON.region.center.longitude}
	                	map.panTo(search_location)
                        
                        // drop markers
                        for (var i = 0; i < jqXHR.responseJSON.businesses.length; i++) {
                        	self.locations.push(new Location(jqXHR.responseJSON.businesses[i]));
                        	addMarker(jqXHR.responseJSON.businesses[i]);
                        }

                    })
	                .fail(function(jqXHR, textStatus, errorThrown) {
                        console.log('error[' + errorThrown + '], status[' + textStatus + '], jqXHR[' + JSON.stringify(jqXHR) + ']');
                        var notification = document.querySelector('.mdl-js-snackbar');
						notification.MaterialSnackbar.showSnackbar({message: 'Could not load results. Please try again.'}
						);
                    })
	            }

        		// clear prev & get results
        		self.fetchResults = function() {
        			self.locations.removeAll();
        			deleteMarkers();
        			self.yelpSearch(self.query());
        		}

        		self.luckyResults = function() {
        			var queries = ['cafes', 'coffee', 'bars', 'tacos', 'ice cream', 'cup cakes', 'burgers', 'pizza', 'sushi'];
        			var places = ['cambridge', 'boston', 'seattle', 'san francisco', 'palo alto', 'portland', 'atlanta', 'denver'];

        			var q = queries[Math.floor(Math.random() * queries.length)];
        			var loc = places[Math.floor(Math.random() * places.length)];

        			// format random choice and fetch results
        			var query = q + " in " + loc;
        			self.locations.removeAll();
        			deleteMarkers();
        			self.yelpSearch(query);
        		}
        	}

        	ko.applyBindings(new ViewModel());
		</script>
	
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBDX_R6rLizTsk8xQOoRFOJrnpSegKg63k&callback=initMap" async defer></script>
	</body>
</html>